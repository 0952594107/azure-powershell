resources:
- repo: self
  fetchDepth: 1

pool:
  vmImage: 'VS2017-Win2016'

steps:
- powershell: |
   # https://blog.jourdant.me/post/3-ways-to-download-files-with-powershell
   Invoke-WebRequest -Uri 'https://github.com/PowerShell/PowerShell/releases/download/v6.0.4/PowerShell-6.0.4-win-x64.msi' -OutFile 'PowerShell-6.0.4-win-x64.msi'
   
   # https://kevinmarquette.github.io/2016-10-21-powershell-installing-msi-files/
   Start-Process msiexec.exe -Wait -ArgumentList '/I PowerShell-6.0.4-win-x64.msi /quiet' -NoNewWindow
   
   # https://stackoverflow.com/a/49292594/294804
   Write-Host "##vso[task.setvariable variable=PATH;]${env:Path};C:\Program Files\PowerShell\6.0.4\";
  displayName: 'Install PowerShell Core'

- powershell: 'Install-Module platyPS -Force -Confirm:$false -Scope CurrentUser'
  pwsh: true
  displayName: 'Install-Module platyPS'

- task: DotNetCoreCLI@2
  displayName: Build
  inputs:
    command: custom
    custom: msbuild
    arguments: 'build.proj /t:Build /p:Configuration=$(Configuration)'

- task: DotNetCoreCLI@2
  displayName: Test
  inputs:
    command: custom
    custom: msbuild
    arguments: 'build.proj /t:Test /p:Configuration=$(Configuration)'

- task: PublishPipelineArtifact@0
  displayName: 'Save artifacts'
  inputs:
    artifactName: artifacts
    targetPath: artifacts
  condition: succeededOrFailed()

